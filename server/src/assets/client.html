<!DOCTYPE html>
<html lang="en">

<head>
	<link rel="icon" type="image/png" id="favIcon" href="favicon.jpg" />

	<link rel="stylesheet" href="./dependencies/bootstrap.min.css" />
	<script src="./dependencies/jquery.min.js"></script>

	<link rel="stylesheet" href="style.css"/>
	
	<script src="script.js"></script>

	<title>SWTbahn Client</title>
</head>

<body style="margin: 20px">

	<div class="row">
		<div class="col-sm-6">
			<div id="swtLogo"></div>
		</div>
		<div class="col-sm-6">
			<div id="userLogo">Client</div>
		</div>
	</div>
	<hr />

	<h1>Configuration</h1>

	<label>Track Output:</label>
	<input type="text" id=trackOutput value="master" />
	<button id=configButton>Configure</button>
	<span id=configResponse></span>
	<br />
	<br />

	<button id=pingButton>Ping SWTbahn Server</button>
	<span id=pingResponse></span>
	<br />

	<button id=startupButton>Startup</button>
	<span id=startupResponse></span>
	<br />

	<button id=shutdownButton>Shutdown</button>
	<span id=shutdownResponse></span>
	<br />
	<br />

	<span id=sessionGrabId>Session ID: 0, Grab ID: -1</span>
	<br />
	<br />


	<h1>Train Driver</h1>

	<label>Train:</label>
	<select id=grabTrainId>
		<option>cargo_db</option>
		<option>cargo_bayern</option>
		<option>cargo_green</option>
		<option>regional_odeg</option>
		<option>regional_brengdirect</option>
	</select>
	<label>Engine:</label>
	<select id=grabEngine>
		<option>libtrain_engine_default (unremovable)</option>
		<option>libtrain_engine_linear (unremovable)</option>
	</select>
	<button id=grabTrainButton>Grab</button>
	<button id=releaseTrainButton>Release</button>
	<span id=grabTrainResponse></span>
	<br />

	<label>DCC Speed:</label>
	<input type="text" id=dccSpeed value="10" />
	<button id=swapDirection>Swap Direction</button>
	<button id=driveTrainButton>Drive</button>
	<button id=stopTrainButton>Stop</button>
	<span id=driveTrainResponse></span>
	<br />

	<label>Route:</label>
	<input type="text" id=signalIdFrom value="signal" />
	<label>to</label>
	<input type="text" id=signalIdTo value="signal" />
	<button id=requestRouteButton>Request</button>
	<button id=automaticDriveRouteButton>Automatic Drive Route</button>
	<button id=manualDriveRouteButton>Manual Drive Route</button>
	<span id=routeResponse></span>
	<br />
	<br />
	
	<label>Grabbed statuses:</label>
	<ul>
		<li>
			cargo_db 
			<input type="text" id=dccSpeed_cargo_db /> 
			<button id=driveTrainButton_cargo_db>Drive</button> 
			<button id=releaseTrainButton_cargo_db>Release</button>
		</li>
		<li>
			cargo_green 
			<input type="text" id=dccSpeed_cargo_green /> 
			<button id=driveTrainButton_cargo_green>Drive</button> 
			<button id=releaseTrainButton_cargo_green>Release</button>
		<li>
			cargo_bayern 
			<input type="text" id=dccSpeed_cargo_bayern /> 
			<button id=driveTrainButton_cargo_bayern>Drive</button> 
			<button id=releaseTrainButton_cargo_bayern>Release</button>
		</li>
		<li>
			regional_odeg 
			<input type="text" id=dccSpeed_regional_odeg /> 
			<button id=driveTrainButton_regional_odeg>Drive</button> 
			<button id=releaseTrainButton_regional_odeg>Release</button>
		</li>
		<li>
			regional_brengdirect
			<input type="text" id=dccSpeed_regional_brengdirec t/> 
			<button id=driveTrainButton_regional_brengdirect>Drive</button> 
			<button id=releaseTrainButton_regional_brengdirect>Release</button>
		</li>
	</ul>
	
	<br />
		

	<h1>Controller</h1>

	<label>Release Route:</label>
	<input type="text" id=routeId value="None" />
	<button id=releaseRouteButton>Release</button>
	<span id=releaseRouteResponse></span>
	<br />

	<label>Point:</label>
	<select id=pointId>
		<option>point1</option>
		<option>point2</option>
		<option>point3</option>
		<option>point4</option>
		<option>point5</option>
		<option>point6</option>
		<option>point7</option>
		<option>point8</option>
		<option>point9</option>
		<option>point10</option>
		<option>point11</option>
		<option>point12</option>
		<option>point13</option>
		<option>point14</option>
		<option>point15</option>
		<option>point16</option>
		<option>point17</option>
		<option>point18a</option>
		<option>point18b</option>
		<option>point19</option>
		<option>point20</option>
		<option>point21</option>
		<option>point22</option>
		<option>point23</option>
		<option>point24</option>
		<option>point25</option>
		<option>point26</option>
		<option>point27</option>
		<option>point28</option>
		<option>point29</option>
	</select>
	<label>Position:</label>
	<select id=pointPosition>
		<option>normal</option>
		<option>reverse</option>
	</select>
	<button id=setPointButton>Set</button>
	<span id=setPointResponse></span>
	<br />

	<label>Signal:</label>
	<select id=signalId>
		<option>signal1</option>
		<option>signal2</option>
		<option>signal3</option>
		<option>signal4</option>
		<option>signal4a</option>
		<option>signal4b</option>
		<option>signal5</option>
		<option>signal6</option>
		<option>signal7</option>
		<option>signal7a</option>
		<option>signal7b</option>
		<option>signal8</option>
		<option>signal9</option>
		<option>signal10</option>
		<option>signal11</option>
		<option>signal12</option>
		<option>signal13</option>
		<option>signal14</option>
		<option>signal15</option>
		<option>signal16</option>
		<option>signal17</option>
		<option>signal18</option>
		<option>signal18a</option>
		<option>signal18b</option>
		<option>signal19</option>
		<option>signal20</option>
		<option>signal21</option>
		<option>signal22</option>
		<option>signal22a</option>
		<option>signal22b</option>
		<option>signal23</option>
		<option>signal24</option>
		<option>signal25</option>
		<option>signal26</option>
		<option>signal27</option>
		<option>signal28</option>
		<option>signal29</option>
		<option>signal30</option>
		<option>signal31</option>
		<option>signal32</option>
		<option>signal33</option>
		<option>signal34</option>
		<option>signal35</option>
		<option>signal35a</option>
		<option>signal35b</option>
		<option>signal36</option>
		<option>signal37</option>
		<option>signal38</option>
		<option>signal39</option>
		<option>signal40</option>
		<option>signal41</option>
		<option>signal42</option>
		<option>signal43</option>
		<option>signal44</option>
		<option>signal45</option>
		<option>signal46</option>
		<option>signal46a</option>
		<option>signal46b</option>
		<option>signal47</option>
		<option>signal48</option>
		<option>signal48a</option>
		<option>signal48b</option>
		<option>signal49</option>
		<option>signal50</option>
		<option>signal50a</option>
		<option>signal50b</option>
		<option>signal51</option>
		<option>signal52</option>
		<option>signal53</option>
		<option>signal53a</option>
		<option>signal53b</option>
		<option>platformlight1</option>
		<option>platformlight2</option>
		<option>platformlight4a</option>
		<option>platformlight4b</option>
		<option>platformlights</option>
	</select>
	<label>Aspect:</label>
	<select id=signalAspect>
		<option>aspect_stop</option>
		<option>aspect_go</option>
		<option>aspect_caution</option>
		<option>aspect_shunt</option>
	</select>
	<button id=setSignalButton>Set</button>
	<span id=setSignalResponse></span>
	<br />
	
	<label>Peripheral:</label>
	<input id=peripheralId>
	<label>Aspect:</label>
	<input id=peripheralState>
	<button id=setPeripheralStateButton>Set</button>
	<span id=setPeripheralResponse></span>
	<br />
	<br />
	
	<label>Granted routes:</label>
	<ul id=grantedRoutes></ul>
	
	<br />

	<h1>Custom Engines and Interlockers</h1>
	
	<label>SCCharts (*.sctx) or Bahn (*.bahn) File:</label>
	<input type="file" id=selectUploadFile accept=".sctx,.bahn" />
	<br />
	<button id=uploadEngineButton>Upload SCCharts</button>
	<button id="uploadInterlockerButton">Upload Bahn</button>	 
	<span id=uploadResponse></span>
	<br />
	<br/>
	
	
	<label>Available Engines:</label>
	<select id=availableEngines>
		<option>libtrain_engine_default (unremovable)</option>
		<option>libtrain_engine_linear (unremovable)</option>
	</select>
	<button id=refreshEnginesButton>Refresh</button>
	<button id=removeEngineButton>Remove</button>
	<span id=refreshRemoveEngineResponse></span>
	<br />

	<label>Available Interlockers:</label>
	<select id="availableInterlockers">
		<option>libinterlocker_default (unremovable)</option>
		<option>libinterlocker_simple_sectional (unremovable)</option>
	</select>
	<button id="unsetInterlockerButton">Unset</button>
	<button id="setInterlockerButton">Set</button>
	<button id="refreshInterlockersButton">Refresh</button>
	<button id="removeInterlockerButton">Remove</button>
	<span id="refreshRemoveInterlockerResponse"></span>
	<br />
	
	<label>Interlocker in use:</label>
	<span id="interlockerInUse">libinterlocker_default (unremovable)</span>
	<br />
	<br />
	
	<h1>Verification</h1>
	<div class="form-group" style="height: 2em;">
		<label>Verification for Train Engines </label>
		<input type="checkbox" id="verificationToggle" data-toggle="toggle" data-size="xs">
		<div class="alert" style="width: auto; height: 1.5em; padding-top: 4px; padding-bottom: 4px; display: inline;" role="alert">
			<span style="margin: auto; margin-top: 0px; height: 1.5em;" id=verificationSettingResponse></span>
		</div>
	</div>
	<div class="form-group" style="height: 2em;">
		<label>Verification Server URL:</label>
		<input type="url" id=verificationServerUrlInput />
		<button id="setVerificationServerUrlButton">Set</button>
		<div class="alert" style="width: auto; height: 1.5em; padding-top: 4px; padding-bottom: 4px; display: inline;" role="alert">
			<span style="margin: auto; margin-top: 0px; height: 1.5em;" id=setVerificationServerUrlResponse></span>
		</div>
	</div>
	<div class="form-group" style="height: 2em;">
		<label>Current Verification Server URL:</label>
		<span id="verificationUrlInUse"></span>
	</div>
</body>

<script type="text/javascript">
	const trainStatusTimeout = 500;
	const trainStatusInterval = setInterval(() => {
		updateTrainGrabbedState();
	}, trainStatusTimeout);


	const grantedRoutesTimeout = 500;
	const grantedRoutesInterval = setInterval(() => {
		updateGrantedRoutes($('#grantedRoutes'));
	}, grantedRoutesTimeout);
</script>

<script type="text/javascript">
	// Script for handling Verification Server URL setting and getting
	$('#setVerificationServerUrlButton').click(function () {
		$('#setVerificationServerUrlResponse').text('Waiting');
		var verif_url = $('#verificationServerUrlInput').val();
		$.ajax({
			type: 'POST',
			url: '/admin/set-verification-url',
			crossDomain: true,
			data: { 'verification-url': verif_url},
			dataType: 'text',
			success: function (responseData, textStatus, jqXHR) {
				info_str = "Set verification server url to " + verif_url + ".";
				console.log(info_str);
				$('#setVerificationServerUrlResponse').parent().show();
				$('#setVerificationServerUrlResponse').text(info_str);
				$('#setVerificationServerUrlResponse').parent().removeClass('alert-danger');
				$('#setVerificationServerUrlResponse').parent().addClass('alert-success');
			},
			error: function (responseData, textStatus, errorThrown) {
				info_str = "Failed to set verification server url to " + verif_url + ".";
				console.log(info_str);
				$('#setVerificationServerUrlResponse').parent().show();
				$('#setVerificationServerUrlResponse').text(info_str);
				$('#setVerificationServerUrlResponse').parent().removeClass('alert-success');
				$('#setVerificationServerUrlResponse').parent().addClass('alert-danger');
			}
		});
	});
	
	function update_verification_url_display() {
		$('#setVerificationServerUrlResponse').parent().hide();
		$.ajax({
			type: 'GET',
			url: '/monitor/verification-url',
			crossDomain: true,
			dataType: 'text',
			success: function (responseData, textStatus, jqXHR) {
				var ret = responseData.replace("verification-url: ",'');
				$('#verificationUrlInUse').text(ret);
			},
			error: function (responseData, textStatus, errorThrown) {
				$('#verificationUrlInUse').text("Unknown");
			}
		});
	}
	update_verification_url_display();
	verif_url_update_interval = setInterval(() => { 
		update_verification_url_display();
	}, 10000);
</script>

<script type="text/javascript">
	current_toggle_pos = false;
	toggleInit = false;
	// Update Toggle: Check if Verification is enabled and update toggle accordingly
	function update_verification_toggle() {
		$('#verificationSettingResponse').parent().hide();
		$.ajax({
			type: 'GET',
			url: '/monitor/verification-option',
			crossDomain: true,
			dataType: 'text',
			success: function (responseData, textStatus, jqXHR) {
				try {
					// Mark toggle initialized
					toggleInit = true;
					if (responseData === "verification-enabled: true") {
						// First option for Gecko/Firefox default; 
						// second bootstrap setter is needed for some Chromium browsers
						current_toggle_pos = true;
						$('#verificationToggle').prop('checked',true);
						$('#verificationToggle').bootstrapToggle('on');
					} else if (responseData === "verification-enabled: false") {
						current_toggle_pos = false;
						$('#verificationToggle').prop('checked',false);
						$('#verificationToggle').bootstrapToggle('off');
					}
				} catch (error) {
					// This is expected when a browser is used that does not
					// support "bootstrapToggle". 
					console.log("Get Verification success case parsing error: " + error);
				}
			},
			error: function (responseData, textStatus, errorThrown) {
				// Mark as initialized on error as well, as else nothing about the toggle will work
				toggleInit = true;
				console.log("Get Verification error case, server response: " + responseData);
			}
		});
	}
	update_verification_toggle();
	verif_toggle_update_interval = setInterval(() => { 
		update_verification_toggle();
	}, 10000);
	
	// Something (User or script) changes toggle
	$('#verificationToggle').change(function () {
		if (!toggleInit) { 
			//if not yet initialized, skip
			return;
		}
		var toggleState = $('#verificationToggle').prop('checked');
		// Check that the toggle state is different than the current aspect because this also
		// triggers when the toggle is adjusted in update_verification_toggle, in which case the
		// toggle is already in the correct aspect, thus no request has to be sent to the server
		if (toggleState == current_toggle_pos) {
			return;
		}
		// Send request to server to set verification accordingly.
		$.ajax({
			type: 'POST',
			url: '/admin/set-verification-option',
			crossDomain: true,
			data: { 'verification-option': toggleState},
			dataType: 'text',
			success: function (responseData, textStatus, jqXHR) {
				info_str = (toggleState ? "Enabled" : "Disabled") + " verification.";
				console.log(info_str);
				$('#verificationSettingResponse').parent().show();
				$('#verificationSettingResponse').text(info_str);
				$('#verificationSettingResponse').parent().removeClass('alert-danger');
				$('#verificationSettingResponse').parent().addClass('alert-success');
				current_toggle_pos = toggleState;
			},
			error: function (responseData, textStatus, errorThrown) {
				info_str = "Failed to " + (toggleState ? "enable" : "disable") + " verification.";
				console.log(info_str);
				$('#verificationSettingResponse').parent().show();
				$('#verificationSettingResponse').text(info_str);
				$('#verificationSettingResponse').parent().removeClass('alert-success');
				$('#verificationSettingResponse').parent().addClass('alert-danger');
				try {
					$('#verificationToggle').prop('checked',current_toggle_pos);
					$('#verificationToggle').bootstrapToggle(current_toggle_pos ? 'on' : 'off');
				} catch (error) {
					// expected err for missing bootstrapToggle on some browsers
				}
			}
		});
	});
</script>

</html>






















